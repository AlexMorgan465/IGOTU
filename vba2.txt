Option Explicit

Sub ExtraireMailVersTableau()

    Dim wsSource As Worksheet
    Dim wsDest As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim contenu As String
    Dim adresse As String
    
    ' Adapter si nécessaire
    Set wsSource = Workbooks("Mail.xlsx").Sheets(1)
    Set wsDest = ThisWorkbook.Sheets(1)
    
    lastRow = wsSource.Cells(wsSource.Rows.Count, "A").End(xlUp).Row
    
    For i = 2 To lastRow
        
        contenu = wsSource.Cells(i, "A").Value
        
        If contenu <> "" Then
            
            wsDest.Cells(i, 2).Value = ExtraireValeur(contenu, "Prénom :")
            wsDest.Cells(i, 3).Value = ExtraireValeur(contenu, "Nom :")
            wsDest.Cells(i, 4).Value = ExtraireValeur(contenu, "Email :")
            wsDest.Cells(i, 5).Value = ExtraireValeur(contenu, "Téléphone :")
            
            adresse = ExtraireValeur(contenu, "Adresse du bien :")
            wsDest.Cells(i, 6).Value = adresse
            
            Call ExtraireCPVille(adresse, wsDest, i)
            
        End If
        
    Next i
    
    MsgBox "Extraction terminée avec succès.", vbInformation

End Sub



Function ExtraireValeur(texte As String, motCle As String) As String

    Dim posDebut As Long
    Dim posFin As Long
    Dim valeur As String
    
    posDebut = InStr(1, texte, motCle, vbTextCompare)
    
    If posDebut = 0 Then
        ExtraireValeur = ""
        Exit Function
    End If
    
    posDebut = posDebut + Len(motCle)
    
    posFin = ProchainLabel(texte, posDebut)
    
    If posFin = 0 Then
        valeur = Mid(texte, posDebut)
    Else
        valeur = Mid(texte, posDebut, posFin - posDebut)
    End If
    
    ExtraireValeur = Trim(valeur)

End Function



Function ProchainLabel(texte As String, startPos As Long) As Long

    Dim labels As Variant
    Dim i As Integer
    Dim pos As Long
    Dim minPos As Long
    
    labels = Array("Nom :", "Prénom :", "Email :", "Téléphone :", "Adresse du bien :")
    
    minPos = 0
    
    For i = LBound(labels) To UBound(labels)
        
        pos = InStr(startPos, texte, labels(i), vbTextCompare)
        
        If pos > 0 Then
            If minPos = 0 Or pos < minPos Then
                minPos = pos
            End If
        End If
        
    Next i
    
    ProchainLabel = minPos

End Function



Sub ExtraireCPVille(adresse As String, ws As Worksheet, ligne As Long)

    Dim parts() As String
    Dim i As Integer
    
    parts = Split(adresse, " ")
    
    For i = 0 To UBound(parts)
        
        If Len(parts(i)) = 5 And IsNumeric(parts(i)) Then
            
            ws.Cells(ligne, 7).Value = parts(i) ' Code Postal
            
            If i < UBound(parts) Then
                ws.Cells(ligne, 8).Value = Join(Application.Index(parts, 0, 0), " ")
            End If
            
            Exit For
            
        End If
        
    Next i

End Sub