<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIDS | Banking Data Intelligence Console</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="sample-data.js"></script>
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e40af;
            --secondary: #3b82f6;
            --accent: #10b981;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --border: #e2e8f0;
            --sidebar-width: 380px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light);
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: #0f172a;
            color: #e2e8f0;
            --light: #1e293b;
            --dark: #f1f5f9;
            --border: #334155;
            --gray: #94a3b8;
        }

        /* Main Container */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .sidebar {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
        }

        /* Header */
        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .bank-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .bank-logo {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bank-info h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .bank-info .tagline {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .theme-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .security-banner {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* Data Panel - FIXED SCROLLING */
        .data-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }

        .panel-content {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.95);
        }

        .section-title i {
            font-size: 1.1rem;
            color: #60a5fa;
        }

        /* File Upload */
        .upload-zone {
            border: 2px dashed rgba(96, 165, 250, 0.4);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(96, 165, 250, 0.05);
        }

        .upload-zone:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .upload-icon {
            font-size: 2.5rem;
            color: #60a5fa;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 0.95rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .upload-hint {
            font-size: 0.8rem;
            opacity: 0.7;
            line-height: 1.4;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            flex-shrink: 0;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .status-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .status-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
            flex-shrink: 0;
        }

        .status-dot.ready {
            background: var(--accent);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-name {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .status-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .status-value.ready {
            color: var(--accent);
        }

        .status-value.missing {
            color: var(--danger);
        }

        /* History - FIXED SCROLLING */
        .history-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 200px;
            max-height: 300px;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--secondary);
            font-size: 0.85rem;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-time {
            color: #60a5fa;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .history-question {
            margin-bottom: 3px;
            opacity: 0.9;
            word-break: break-word;
        }

        .history-answer {
            opacity: 0.7;
            font-size: 0.8rem;
            word-break: break-word;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--light);
            position: relative;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 10;
        }

        .page-title h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .page-title p {
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .session-badge {
            background: #f0f9ff;
            color: #0369a1;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #bae6fd;
        }

        .dark-mode .session-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .clear-btn {
            background: #f1f5f9;
            color: var(--gray);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dark-mode .clear-btn {
            background: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        .clear-btn:hover {
            background: #e2e8f0;
        }

        .dark-mode .clear-btn:hover {
            background: #475569;
        }

        /* Chat Container - FIXED SCROLLING */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        /* Chat Messages - FIXED SCROLLING */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
            min-height: 0; /* Important for flex scrolling */
        }

        /* Welcome Message */
        .welcome-message {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid #bae6fd;
            flex-shrink: 0;
        }

        .dark-mode .welcome-message {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .welcome-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--secondary) 0%, #1d4ed8 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .welcome-message h3 {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .dark-mode .welcome-message h3 {
            color: #f1f5f9;
        }

        .welcome-message p {
            color: var(--gray);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #475569;
        }

        .dark-mode .feature-item {
            color: #cbd5e1;
        }

        .feature-item i {
            color: var(--secondary);
        }

        /* Message Bubbles */
        .message {
            max-width: 70%;
            animation: fadeIn 0.3s ease-out;
            flex-shrink: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            align-self: flex-end;
            margin-left: auto;
        }

        .message-bot {
            align-self: flex-start;
            margin-right: auto;
        }

        .message-bubble {
            padding: 18px 20px;
            border-radius: 18px;
            position: relative;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            word-break: break-word;
        }

        .user-bubble {
            background: linear-gradient(135deg, var(--secondary) 0%, #1d4ed8 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot-bubble {
            background: white;
            border: 1px solid var(--border);
            border-bottom-left-radius: 5px;
        }

        .dark-mode .bot-bubble {
            background: #334155;
            border-color: #475569;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-sender {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-bubble .message-sender {
            color: rgba(255, 255, 255, 0.95);
        }

        .bot-bubble .message-sender {
            color: var(--secondary);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: white;
            border-radius: 18px;
            border: 1px solid var(--border);
            width: fit-content;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            flex-shrink: 0;
        }

        .dark-mode .typing-indicator {
            background: #334155;
            border-color: #475569;
        }

        .typing-text {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Input Area - FIXED POSITION */
        .input-container {
            background: var(--light);
            border-top: 1px solid var(--border);
            padding: 20px 30px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-shrink: 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            background: #f8fafc;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .dark-mode .input-wrapper {
            background: #334155;
            border-color: #475569;
        }

        .input-wrapper:focus-within {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #user-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 15px;
            font-size: 1rem;
            color: var(--dark);
            outline: none;
            min-height: 24px;
            max-height: 120px;
            resize: none;
            font-family: inherit;
        }

        .dark-mode #user-input {
            color: #f1f5f9;
        }

        #user-input::placeholder {
            color: #94a3b8;
        }

        .input-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .action-btn {
            background: #f1f5f9;
            color: var(--gray);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .dark-mode .action-btn {
            background: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        .action-btn:hover {
            background: #e2e8f0;
        }

        .dark-mode .action-btn:hover {
            background: #475569;
        }

        #send-btn {
            background: linear-gradient(135deg, var(--secondary) 0%, #1d4ed8 100%);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        #send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
        }

        /* File Input */
        #file-input {
            display: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: #334155;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 400px;
            }
            
            .main-content {
                height: calc(100vh - 400px);
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .input-container {
                padding: 15px 20px;
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
            flex-shrink: 0;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="bank-brand">
                    <div class="bank-logo">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="bank-info">
                        <h1>EIDS Banking</h1>
                        <div class="tagline">Data Intelligence Platform</div>
                    </div>
                </div>
                <button class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <div class="security-banner">
                    <i class="fas fa-shield-alt"></i>
                    <span>Secure Session â€¢ GDPR Compliant</span>
                </div>
            </div>

            <div class="data-panel">
                <div class="panel-content">
                    <!-- Data Import -->
                    <div class="panel-section">
                        <div class="section-title">
                            <i class="fas fa-database"></i>
                            Data Import
                        </div>
                        
                        <div class="upload-zone" id="upload-zone">
                            <div class="upload-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <div class="upload-text">
                                Drag & Drop Excel File
                            </div>
                            <div class="upload-hint">
                                Supports .xlsx, .xls, .csv formats
                            </div>
                        </div>
                        
                        <button class="btn-primary" id="upload-btn">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Import Banking Data
                        </button>
                        
                        <button class="btn-secondary" id="sample-data-btn">
                            <i class="fas fa-chart-line"></i>
                            Use Sample Data
                        </button>
                        
                        <input type="file" id="file-input" accept=".xlsx, .xls, .csv">
                    </div>

                    <!-- Data Status -->
                    <div class="panel-section">
                        <div class="section-title">
                            <i class="fas fa-clipboard-check"></i>
                            Data Status
                        </div>
                        
                        <div class="status-grid">
                            <div class="status-card" id="dataset-card">
                                <div class="status-header">
                                    <div class="status-dot" id="dataset-dot"></div>
                                    <div class="status-name">DataSet</div>
                                </div>
                                <div class="status-value" id="dataset-status">Not loaded</div>
                            </div>
                            
                            <div class="status-card" id="synonyms-card">
                                <div class="status-header">
                                    <div class="status-dot" id="synonyms-dot"></div>
                                    <div class="status-name">Synonyms</div>
                                </div>
                                <div class="status-value" id="synonyms-status">Not loaded</div>
                            </div>
                            
                            <div class="status-card" id="extensions-card">
                                <div class="status-header">
                                    <div class="status-dot" id="extensions-dot"></div>
                                    <div class="status-name">Extensions</div>
                                </div>
                                <div class="status-value" id="extensions-status">Not loaded</div>
                            </div>
                            
                            <div class="status-card" id="temp-card">
                                <div class="status-header">
                                    <div class="status-dot" id="temp-dot"></div>
                                    <div class="status-name">Session Log</div>
                                </div>
                                <div class="status-value" id="temp-status">Empty</div>
                            </div>
                        </div>
                    </div>

                    <!-- Session History -->
                    <div class="panel-section history-section">
                        <div class="section-title">
                            <i class="fas fa-history"></i>
                            Session History
                        </div>
                        
                        <div class="history-list" id="conversation-history">
                            <div class="history-item">
                                <div class="history-time">No data loaded</div>
                                <div class="history-question">Upload data to begin session</div>
                                <div class="history-answer">Import Excel file or use sample data</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">
                    <h2>Intelligent Data Assistant</h2>
                    <p>AI-powered with advanced question understanding</p>
                </div>
                
                <div class="session-info">
                    <div class="session-badge">
                        <i class="fas fa-brain"></i>
                        <span>Smart Matching Active</span>
                    </div>
                    <button class="clear-btn" id="clear-chat-btn">
                        <i class="fas fa-eraser"></i>
                        Clear Chat
                    </button>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-history">
                    <!-- Welcome Message -->
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>Welcome to Intelligent Assistant</h3>
                        <p>I understand questions in any format! Use uppercase, lowercase, special characters, or accented letters. Upload your data or use our sample dataset to begin.</p>
                        
                        <div class="features-grid">
                            <div class="feature-item">
                                <i class="fas fa-language"></i>
                                <span>Smart Text Normalization</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-search"></i>
                                <span>Fuzzy Matching</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Case Insensitive</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-magic"></i>
                                <span>Contextual Understanding</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area - FIXED POSITION -->
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea id="user-input" placeholder="Ask your question in any format..." rows="1"></textarea>
                        <button id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <div class="input-actions">
                        <button class="action-btn" id="quick-help-btn">
                            <i class="fas fa-question-circle"></i>
                            Quick Help
                        </button>
                        <button class="action-btn" id="export-history-btn">
                            <i class="fas fa-download"></i>
                            Export History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ============ INTELLIGENT QUESTION MATCHING SYSTEM ============

        // DOM Elements
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-input');
        const uploadZone = document.getElementById('upload-zone');
        const uploadBtn = document.getElementById('upload-btn');
        const sampleDataBtn = document.getElementById('sample-data-btn');
        const conversationHistory = document.getElementById('conversation-history');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const quickHelpBtn = document.getElementById('quick-help-btn');
        const exportHistoryBtn = document.getElementById('export-history-btn');
        const themeToggle = document.getElementById('theme-toggle');

        // Status elements
        const datasetStatus = document.getElementById('dataset-status');
        const synonymsStatus = document.getElementById('synonyms-status');
        const extensionsStatus = document.getElementById('extensions-status');
        const tempStatus = document.getElementById('temp-status');
        const datasetDot = document.getElementById('dataset-dot');
        const synonymsDot = document.getElementById('synonyms-dot');
        const extensionsDot = document.getElementById('extensions-dot');
        const tempDot = document.getElementById('temp-dot');

        // Excel data storage
        let excelData = {
            DataSet: [],
            Synonyms: [],
            Extensions: [],
            Temp: []
        };

        // ============ TEXT NORMALIZATION FUNCTIONS ============

        /**
         * Normalizes text for intelligent matching
         * - Converts to lowercase
         * - Removes accents/diacritics
         * - Removes special characters
         * - Removes extra spaces
         */
        function normalizeText(text) {
            if (!text || typeof text !== 'string') return '';
            
            // Convert to lowercase
            let normalized = text.toLowerCase();
            
            // Remove accents/diacritics (Ã© â†’ e, Ã¨ â†’ e, Ã  â†’ a, etc.)
            normalized = normalized.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Remove all special characters except letters, numbers, and spaces
            normalized = normalized.replace(/[^a-z0-9\s]/g, ' ');
            
            // Replace multiple spaces with single space and trim
            normalized = normalized.replace(/\s+/g, ' ').trim();
            
            return normalized;
        }

        /**
         * Enhanced normalization with stop word removal
         */
        function normalizeTextAdvanced(text) {
            const normalized = normalizeText(text);
            
            // Common French and English stop words
            const stopWords = [
                // French articles
                'le', 'la', 'les', 'un', 'une', 'des', 'du', 'de',
                // French conjunctions
                'et', 'ou', 'mais', 'donc', 'or', 'ni', 'car',
                // English articles
                'the', 'a', 'an',
                // English conjunctions
                'and', 'or', 'but', 'so', 'for', 'nor', 'yet',
                // Question words
                'what', 'how', 'why', 'when', 'where', 'who', 'which',
                // Common verbs
                'is', 'are', 'was', 'were', 'be', 'been', 'being',
                // French question words
                'que', 'quoi', 'comment', 'pourquoi', 'quand', 'ou', 'qui',
                // Misc
                'est', 'sont', 'cest', 'ca', 'ce', 'cela'
            ];
            
            // Remove stop words
            const words = normalized.split(' ');
            const filteredWords = words.filter(word => 
                word.length > 2 && !stopWords.includes(word)
            );
            
            return filteredWords.join(' ') || normalized;
        }

        /**
         * Calculates similarity between two strings (0 to 1)
         */
        function calculateSimilarity(str1, str2) {
            const s1 = normalizeText(str1);
            const s2 = normalizeText(str2);
            
            if (s1 === s2) return 1;
            if (s1.includes(s2) || s2.includes(s1)) return 0.9;
            
            // Simple Levenshtein-like similarity
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            // Check for word overlap
            const words1 = s1.split(' ');
            const words2 = s2.split(' ');
            const commonWords = words1.filter(word => 
                words2.some(w2 => w2.includes(word) || word.includes(w2))
            );
            
            const wordScore = commonWords.length / Math.max(words1.length, words2.length);
            
            // Character similarity
            let charMatches = 0;
            for (let i = 0; i < Math.min(s1.length, s2.length); i++) {
                if (s1[i] === s2[i]) charMatches++;
            }
            const charScore = charMatches / Math.max(s1.length, s2.length);
            
            return Math.max(wordScore, charScore * 0.5);
        }

        // ============ ENHANCED MATCHING FUNCTIONS ============

        /**
         * Finds the best matching synonym for a user question
         */
        function findBestMatchingSynonym(question) {
            const normalizedQuestion = normalizeTextAdvanced(question);
            if (!normalizedQuestion) return null;
            
            let bestMatch = null;
            let bestScore = 0;
            
            for (const synonymGroup of excelData.Synonyms) {
                if (!synonymGroup || synonymGroup.length === 0) continue;
                
                let groupScore = 0;
                
                for (const synonym of synonymGroup) {
                    if (!synonym || typeof synonym !== 'string') continue;
                    
                    const normalizedSynonym = normalizeTextAdvanced(synonym);
                    if (!normalizedSynonym) continue;
                    
                    // Calculate similarity
                    const similarity = calculateSimilarity(normalizedQuestion, normalizedSynonym);
                    
                    // Boost score for exact word matches
                    const questionWords = normalizedQuestion.split(' ');
                    const synonymWords = normalizedSynonym.split(' ');
                    
                    let exactWordMatches = 0;
                    for (const qWord of questionWords) {
                        if (qWord.length < 3) continue;
                        for (const sWord of synonymWords) {
                            if (sWord.length < 3) continue;
                            if (qWord === sWord) exactWordMatches++;
                        }
                    }
                    
                    const boostedScore = similarity + (exactWordMatches * 0.1);
                    
                    if (boostedScore > groupScore) {
                        groupScore = boostedScore;
                    }
                }
                
                // Require minimum similarity
                if (groupScore > bestScore && groupScore > 0.3) {
                    bestScore = groupScore;
                    bestMatch = synonymGroup;
                }
            }
            
            return bestMatch;
        }

        /**
         * Finds matching data in DataSet
         */
        function findMatchingData(keyword) {
            const normalizedKeyword = normalizeText(keyword);
            
            for (const row of excelData.DataSet) {
                if (!row[0] || typeof row[0] !== 'string') continue;
                
                const normalizedRowKey = normalizeText(row[0]);
                const similarity = calculateSimilarity(normalizedKeyword, normalizedRowKey);
                
                if (similarity > 0.8) {
                    return row;
                }
                
                // Check for partial inclusion
                if (normalizedRowKey.includes(normalizedKeyword) || 
                    normalizedKeyword.includes(normalizedRowKey)) {
                    return row;
                }
            }
            
            return null;
        }

        /**
         * Direct search in DataSet for fallback matching
         */
        function searchDataSetDirectly(question) {
            const normalizedQuestion = normalizeTextAdvanced(question);
            const questionWords = normalizedQuestion.split(' ');
            
            let bestMatch = null;
            let bestScore = 0;
            
            for (const row of excelData.DataSet) {
                if (!row[0] || typeof row[0] !== 'string') continue;
                
                const rowText = normalizeTextAdvanced(row[0]);
                const rowWords = rowText.split(' ');
                
                // Count matching words
                let matchingWords = 0;
                for (const qWord of questionWords) {
                    if (qWord.length < 3) continue;
                    
                    for (const rWord of rowWords) {
                        if (rWord.includes(qWord) || qWord.includes(rWord)) {
                            matchingWords++;
                            break;
                        }
                    }
                }
                
                const score = matchingWords / Math.max(questionWords.length, rowWords.length);
                
                if (score > bestScore && score > 0.3) {
                    bestScore = score;
                    bestMatch = row;
                }
            }
            
            return bestMatch;
        }

        // ============ RESPONSE GENERATION ============

        /**
         * Gets bot response with intelligent matching
         */
        function getBotResponse(userMessage) {
            // Check if data is loaded
            if (excelData.DataSet.length === 0) {
                return "ðŸ“Š Please load data first. Upload an Excel file or use sample data.";
            }
            
            const trimmedMessage = userMessage.trim();
            if (trimmedMessage.length < 2) {
                return "Please ask a question with more details.";
            }
            
            // 1. Try to find matching synonym
            const matchedSynonym = findBestMatchingSynonym(trimmedMessage);
            
            if (matchedSynonym && matchedSynonym[0]) {
                const matchedData = findMatchingData(matchedSynonym[0]);
                if (matchedData) {
                    return formatResponse(matchedData);
                }
            }
            
            // 2. Try direct DataSet search
            const directMatch = searchDataSetDirectly(trimmedMessage);
            if (directMatch) {
                return formatResponse(directMatch);
            }
            
            // 3. Contextual fallback
            return getContextualResponse(trimmedMessage);
        }

        /**
         * Formats response with extensions
         */
        function formatResponse(dataRow) {
            // Get available answers
            const answers = dataRow.slice(1).filter(a => a && a.toString().trim());
            if (answers.length === 0) {
                return `I have information about "${dataRow[0]}" but no detailed answer is available.`;
            }
            
            // Select random answer
            let response = answers[Math.floor(Math.random() * answers.length)];
            
            // Add extensions if available
            response = addExtensions(response);
            
            return response;
        }

        /**
         * Adds random extensions to response
         */
        function addExtensions(response) {
            if (!excelData.Extensions || excelData.Extensions.length === 0) {
                return response;
            }
            
            let finalResponse = response;
            
            // Add beginning extension (30% chance)
            if (Math.random() < 0.3) {
                const beginnings = excelData.Extensions
                    .map(row => row[0])
                    .filter(ext => ext && ext.toString().trim());
                
                if (beginnings.length > 0) {
                    const beginning = beginnings[Math.floor(Math.random() * beginnings.length)];
                    finalResponse = beginning.toString() + ' ' + finalResponse;
                }
            }
            
            // Add ending extension (40% chance)
            if (Math.random() < 0.4) {
                const endings = excelData.Extensions
                    .map(row => row[3] || row[2] || '')
                    .filter(ext => ext && ext.toString().trim());
                
                if (endings.length > 0) {
                    const ending = endings[Math.floor(Math.random() * endings.length)];
                    if (!['.', '!', '?'].includes(finalResponse.slice(-1))) {
                        finalResponse += '.';
                    }
                    finalResponse += ' ' + ending.toString();
                }
            }
            
            return finalResponse;
        }

        /**
         * Provides contextual fallback response
         */
        function getContextualResponse(question) {
            const normalizedQuestion = normalizeText(question);
            
            // Check for greeting
            const greetings = ['bonjour', 'hello', 'salut', 'hi', 'hey', 'coucou', 'bonsoir'];
            if (greetings.some(g => normalizedQuestion.includes(g))) {
                return "ðŸ‘‹ Hello! I'm your intelligent assistant. Ask me anything about the loaded data.";
            }
            
            // Check for help request
            const helpWords = ['help', 'aide', 'assistance', 'comment', 'how', 'aide moi'];
            if (helpWords.some(word => normalizedQuestion.includes(word))) {
                return "I can help you! Try asking specific questions about the data. You can also upload your own Excel file or use sample data.";
            }
            
            // Check for thank you
            const thanksWords = ['merci', 'thanks', 'thank you', 'grazie'];
            if (thanksWords.some(word => normalizedQuestion.includes(word))) {
                return "You're welcome! Is there anything else I can help you with?";
            }
            
            // Check for data-related questions
            const dataWords = ['data', 'donnees', 'information', 'dataset', 'excel', 'file'];
            if (dataWords.some(word => normalizedQuestion.includes(word))) {
                return "I need data to answer questions. Please upload an Excel file or use the sample data button.";
            }
            
            // Generic fallback
            const fallbacks = [
                "I'm not sure I understand. Could you rephrase your question?",
                "That's not in my current knowledge base. Try asking about something in the loaded data.",
                "I don't have information about that. Try loading data or asking a different question.",
                "Could you be more specific? I work best with clear questions about the available data."
            ];
            
            return fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        // ============ UI FUNCTIONS ============

        /**
         * Sends a message
         */
        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Add user message
            addMessageToChat("You", message, true);
            
            // Clear input
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.focus();
            
            // Check if data is loaded
            if (excelData.DataSet.length === 0 && 
                !message.toLowerCase().includes('upload') &&
                !message.toLowerCase().includes('sample') &&
                !message.toLowerCase().includes('data')) {
                
                addMessageToChat("Assistant", 
                    "ðŸ“Š Please load data first. Click 'Use Sample Data' or upload an Excel file.", 
                    false
                );
                return;
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            // Get response after delay
            setTimeout(() => {
                removeTypingIndicator();
                const response = getBotResponse(message);
                addMessageToChat("Assistant", response, false);
                saveToHistory(message, response);
                
                // Auto-scroll
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, 800 + Math.random() * 800);
        }

        /**
         * Shows typing indicator
         */
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-text">Intelligent Assistant is thinking</div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-bot';
            messageDiv.appendChild(typingDiv);
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator && indicator.parentElement) {
                indicator.parentElement.remove();
            }
        }

        /**
         * Adds message to chat UI
         */
        function addMessageToChat(sender, message, isUser) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-bot'}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.innerHTML = `
                <div class="message-sender">${sender}</div>
                <div class="message-time">${time}</div>
            `;
            
            const textDiv = document.createElement('div');
            textDiv.textContent = message;
            textDiv.style.whiteSpace = 'pre-wrap';
            
            bubbleDiv.appendChild(headerDiv);
            bubbleDiv.appendChild(textDiv);
            messageDiv.appendChild(bubbleDiv);
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ============ DATA MANAGEMENT ============

        /**
         * Updates sheet status display
         */
        function updateSheetStatus(sheetName, isLoaded) {
            const statusEl = document.getElementById(`${sheetName.toLowerCase()}-status`);
            const dotEl = document.getElementById(`${sheetName.toLowerCase()}-dot`);
            const cardEl = document.getElementById(`${sheetName.toLowerCase()}-card`);
            
            if (isLoaded) {
                const data = excelData[sheetName];
                const count = data.length;
                statusEl.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
                statusEl.className = 'status-value ready';
                dotEl.className = 'status-dot ready';
                cardEl.style.borderColor = 'rgba(16, 185, 129, 0.3)';
            } else {
                if (sheetName === 'Temp') {
                    statusEl.textContent = 'Empty';
                } else {
                    statusEl.textContent = 'Not loaded';
                }
                statusEl.className = 'status-value missing';
                dotEl.className = 'status-dot';
                cardEl.style.borderColor = 'rgba(255, 255, 255, 0.1)';
            }
        }

        /**
         * Handles file upload
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show uploading state
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            uploadBtn.disabled = true;
            uploadZone.innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="upload-text">
                    Processing ${file.name}
                </div>
                <div class="upload-hint">
                    Intelligent matching system initializing...
                </div>
            `;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    
                    // Extract data from each sheet
                    excelData = {
                        DataSet: extractSheetData(workbook, 'DataSet'),
                        Synonyms: extractSheetData(workbook, 'Synonyms'),
                        Extensions: extractSheetData(workbook, 'Extensions'),
                        Temp: extractSheetData(workbook, 'Temp') || []
                    };
                    
                    // Update status
                    updateSheetStatus('DataSet', excelData.DataSet.length > 0);
                    updateSheetStatus('Synonyms', excelData.Synonyms.length > 0);
                    updateSheetStatus('Extensions', excelData.Extensions.length > 0);
                    updateSheetStatus('Temp', excelData.Temp.length > 0);
                    
                    // Load history
                    loadConversationHistory();
                    
                    // Success message
                    addMessageToChat("Assistant", 
                        `âœ… Successfully loaded "${file.name}"\n` +
                        `ðŸ“Š Found ${excelData.DataSet.length} data entries\n` +
                        `ðŸ”¤ ${excelData.Synonyms.length} synonym groups for intelligent matching\n\n` +
                        `You can now ask questions in any format!`, 
                        false
                    );
                    
                } catch (error) {
                    console.error("Error parsing Excel:", error);
                    addMessageToChat("Assistant", 
                        `âŒ Error: ${error.message}\n` +
                        `Please ensure your Excel file has DataSet, Synonyms, Extensions, and Temp sheets.`, 
                        false
                    );
                } finally {
                    resetUploadUI();
                }
            };
            
            reader.onerror = function() {
                addMessageToChat("Assistant", "âŒ Failed to read file. Please try again.", false);
                resetUploadUI();
            };
            
            reader.readAsBinaryString(file);
        }

        /**
         * Extracts data from Excel sheet
         */
        function extractSheetData(workbook, sheetName) {
            if (!workbook.SheetNames.includes(sheetName)) {
                console.warn(`Sheet "${sheetName}" not found`);
                return [];
            }
            
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            return data.filter(row => row.some(cell => 
                cell !== null && cell !== undefined && cell.toString().trim() !== ''
            ));
        }

        /**
         * Resets upload UI
         */
        function resetUploadUI() {
            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Import Banking Data';
            uploadBtn.disabled = false;
            uploadZone.innerHTML = `
                <div class="upload-icon">
                    <i class="fas fa-file-excel"></i>
                </div>
                <div class="upload-text">
                    Drag & Drop Excel File
                </div>
                <div class="upload-hint">
                    Supports .xlsx, .xls, .csv formats
                </div>
            `;
        }

        /**
         * Loads sample data
         */
        function loadSampleData() {
            sampleDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            sampleDataBtn.disabled = true;
            
            setTimeout(() => {
                try {
                    if (typeof sampleData === 'undefined') {
                        throw new Error('Sample data not available');
                    }
                    
                    excelData = {
                        DataSet: [...(sampleData.DataSet || [])],
                        Synonyms: [...(sampleData.Synonyms || [])],
                        Extensions: [...(sampleData.Extensions || [])],
                        Temp: [...(sampleData.Temp || [])]
                    };
                    
                    updateSheetStatus('DataSet', true);
                    updateSheetStatus('Synonyms', true);
                    updateSheetStatus('Extensions', true);
                    updateSheetStatus('Temp', excelData.Temp.length > 0);
                    
                    loadConversationHistory();
                    
                    addMessageToChat("Assistant", 
                        "âœ¨ Intelligent sample data loaded!\n\n" +
                        "I now understand questions in any format:\n" +
                        "â€¢ UPPERCASE, lowercase, MixedCase\n" +
                        "â€¢ With special characters: ,;:!?\n" +
                        "â€¢ With accents: Ã©, Ã¨, Ã , Ã¹\n" +
                        "â€¢ Different phrasing\n\n" +
                        "Try asking about PDF accessibility, Anello Iannuzzi, or banking data!", 
                        false
                    );
                    
                } catch (error) {
                    console.error('Error:', error);
                    addMessageToChat("Assistant", 
                        "âš ï¸ Could not load sample data. Please check if sample-data.js is available.", 
                        false
                    );
                } finally {
                    sampleDataBtn.innerHTML = '<i class="fas fa-chart-line"></i> Use Sample Data';
                    sampleDataBtn.disabled = false;
                }
            }, 1000);
        }

        // ============ HISTORY MANAGEMENT ============

        /**
         * Saves conversation to history
         */
        function saveToHistory(question, answer) {
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const historyItem = [timestamp, question, answer];
            
            excelData.Temp.push(historyItem);
            updateSheetStatus('Temp', true);
            addToHistoryPanel(historyItem);
        }

        /**
         * Adds item to history panel
         */
        function addToHistoryPanel(item) {
            const historyDiv = document.getElementById('conversation-history');
            
            // Remove placeholder
            const placeholder = historyDiv.querySelector('.history-item');
            if (placeholder && placeholder.querySelector('.history-time').textContent === 'No data loaded') {
                placeholder.remove();
            }
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'history-item';
            itemDiv.innerHTML = `
                <div class="history-time">${item[0]}</div>
                <div class="history-question">${item[1]}</div>
                <div class="history-answer">${item[2].substring(0, 60)}${item[2].length > 60 ? '...' : ''}</div>
            `;
            
            // Add click to view full
            itemDiv.addEventListener('click', () => {
                addMessageToChat("You", item[1], true);
                setTimeout(() => {
                    addMessageToChat("Assistant", item[2], false);
                }, 300);
            });
            
            historyDiv.insertBefore(itemDiv, historyDiv.firstChild);
            
            // Limit to 20 items
            if (historyDiv.children.length > 20) {
                historyDiv.removeChild(historyDiv.lastChild);
            }
            
            // Scroll to top
            historyDiv.scrollTop = 0;
        }

        /**
         * Loads conversation history
         */
        function loadConversationHistory() {
            const historyDiv = document.getElementById('conversation-history');
            historyDiv.innerHTML = '';
            
            if (excelData.Temp.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'history-item';
                placeholder.innerHTML = `
                    <div class="history-time">No data loaded</div>
                    <div class="history-question">Upload data to begin session</div>
                    <div class="history-answer">Import Excel file or use sample data</div>
                `;
                historyDiv.appendChild(placeholder);
                return;
            }
            
            // Show last 20 items
            const recent = excelData.Temp.slice(-20).reverse();
            recent.forEach(item => addToHistoryPanel(item));
        }

        // ============ UTILITY FUNCTIONS ============

        /**
         * Clears chat
         */
        function clearChat() {
            // Remove all messages except welcome message
            const messages = chatHistory.querySelectorAll('.message');
            messages.forEach(msg => {
                if (!msg.closest('.welcome-message')) {
                    msg.remove();
                }
            });
            
            addMessageToChat("Assistant", "Chat cleared. You can continue asking questions in any format!", false);
        }

        /**
         * Shows quick help
         */
        function showQuickHelp() {
            addMessageToChat("Assistant", 
                `ðŸ¤– **Intelligent Assistant Help**\n\n` +
                `**Smart Features:**\n` +
                `â€¢ Understands questions in ANY format\n` +
                `â€¢ Case insensitive (PDF = pdf = Pdf)\n` +
                `â€¢ Ignores special characters (,;:!?"')\n` +
                `â€¢ Handles accents (Ã©, Ã¨, Ã , Ã¹)\n` +
                `â€¢ Fuzzy matching for similar words\n\n` +
                `**How to Use:**\n` +
                `1. Load data (sample or upload Excel)\n` +
                `2. Ask questions naturally\n` +
                `3. Use any formatting you like\n\n` +
                `**Examples that all work:**\n` +
                `â€¢ "QU'EST-CE QUE LE BALISAGE PDF?"\n` +
                `â€¢ "c'est quoi le balisage pdf"\n` +
                `â€¢ "BALISAGE PDF dÃ©finition!!!"\n` +
                `â€¢ "expliquez le balisage d'un pdf."\n\n` +
                `**Try asking about:**\n` +
                `â€¢ PDF accessibility\n` +
                `â€¢ Anello Iannuzzi\n` +
                `â€¢ Banking data analysis`, 
                false
            );
        }

        /**
         * Exports history
         */
        function exportHistory() {
            if (excelData.Temp.length === 0) {
                addMessageToChat("Assistant", "No conversation history to export.", false);
                return;
            }
            
            // Create CSV content
            let csv = "Time,Question,Answer\n";
            excelData.Temp.forEach(item => {
                csv += `"${item[0]}","${item[1].replace(/"/g, '""')}","${item[2].replace(/"/g, '""')}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `intelligent-chat-history-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addMessageToChat("Assistant", "âœ… Conversation history exported as CSV.", false);
        }

        /**
         * Toggles dark/light theme
         */
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            if (isDark) {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
            }
        }

        // ============ EVENT LISTENERS ============

        // Send message
        sendBtn.addEventListener('click', sendMessage);
        
        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // Enter to send (Shift+Enter for new line)
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // File upload
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = '#3b82f6';
            uploadZone.style.background = 'rgba(59, 130, 246, 0.1)';
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = 'rgba(96, 165, 250, 0.4)';
            uploadZone.style.background = 'rgba(96, 165, 250, 0.05)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'rgba(96, 165, 250, 0.4)';
            uploadZone.style.background = 'rgba(96, 165, 250, 0.05)';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload({ target: fileInput });
            }
        });

        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        
        // Other buttons
        sampleDataBtn.addEventListener('click', loadSampleData);
        clearChatBtn.addEventListener('click', clearChat);
        quickHelpBtn.addEventListener('click', showQuickHelp);
        exportHistoryBtn.addEventListener('click', exportHistory);
        themeToggle.addEventListener('click', toggleTheme);

        // ============ INITIALIZATION ============

        // Initialize status
        updateSheetStatus('DataSet', false);
        updateSheetStatus('Synonyms', false);
        updateSheetStatus('Extensions', false);
        updateSheetStatus('Temp', false);

        // Check saved theme
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
        }

        // Focus input
        setTimeout(() => {
            userInput.focus();
        }, 500);
    </script>
</body>
</html>