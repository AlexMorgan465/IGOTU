<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cofidis Fixed Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --cofidis-red: #E2001A;
            --sidebar-width: 250px;
            --card-height: 450px; /* Taille fixe pour tous les graphiques */
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #F0F2F5;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden; /* Empêche le scroll sur tout le corps */
        }

        /* Sidebar reste fixe */
        aside {
            width: var(--sidebar-width);
            background: #1A1A1A;
            color: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .brand { padding: 30px; font-size: 1.5rem; font-weight: 900; color: var(--cofidis-red); }

        /* Zone de contenu scrollable mais structure fixe */
        main {
            flex-grow: 1;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 20px 40px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            padding: 30px;
            width: 100%;
            max-width: 1600px; /* Limite la largeur max pour éviter le stretch horizontal */
            margin: 0 auto;
            box-sizing: border-box;
        }

        /* GRILLE FIXE : 2 colonnes strictes */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 50% / 50% strict */
            gap: 25px;
            width: 100%;
        }

        /* CARDS FIXES */
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            height: var(--card-height); /* Hauteur imposée */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Empêche le contenu de dépasser */
        }

        .chart-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            color: #333;
            flex-shrink: 0;
        }

        /* Conteneur du canvas pour forcer la taille */
        .canvas-container {
            flex-grow: 1;
            position: relative;
            min-height: 0; /* Important pour Chart.js dans un flexbox */
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* KPI fixes */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--cofidis-red);
            text-align: center;
        }

        .kpi-card span { display: block; font-size: 1.8rem; font-weight: bold; }
    </style>
</head>
<body>

<aside>
    <div class="brand">COFIDIS</div>
    <div style="padding: 20px; opacity: 0.6;">Analyse de données</div>
</aside>

<main>
    <header>
        <h2>Tableau de Bord</h2>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
    </header>

    <div class="container">
        <div class="kpi-row">
            <div class="kpi-card"><small>Total</small><span id="total">0</span></div>
            <div class="kpi-card"><small>Acceptation</small><span id="rate">0%</span></div>
            <div class="kpi-card"><small>Digital</small><span id="digital">0%</span></div>
            <div class="kpi-card"><small>Agents</small><span id="agents">0</span></div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-card">
                <h3>Répartition Produits</h3>
                <div class="canvas-container"><canvas id="chart1"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>Statut Décisions</h3>
                <div class="canvas-container"><canvas id="chart2"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>Top Gestionnaires</h3>
                <div class="canvas-container"><canvas id="chart3"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>Canaux d'entrée</h3>
                <div class="canvas-container"><canvas id="chart4"></canvas></div>
            </div>
        </div>
    </div>
</main>

<script>
    let charts = {};

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = new Uint8Array(event.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            updateDashboard(json);
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function updateDashboard(data) {
        const stats = {
            prod: count(data, 'Type de produit'),
            dec: count(data, 'Decision'),
            agent: count(data, 'Agent'),
            canal: count(data, 'Canal')
        };

        // Update KPIs
        document.getElementById('total').innerText = data.length;
        document.getElementById('agents').innerText = Object.keys(stats.agent).length;

        // Render Charts
        render('chart1', 'doughnut', stats.prod);
        render('chart2', 'pie', stats.dec);
        render('chart3', 'bar', stats.agent, true);
        render('chart4', 'bar', stats.canal);
    }

    function count(data, key) {
        return data.reduce((acc, row) => {
            const v = row[key] || "N/C";
            acc[v] = (acc[v] || 0) + 1;
            return acc;
        }, {});
    }

    function render(id, type, dataObj, horizontal = false) {
        if (charts[id]) charts[id].destroy();
        
        const ctx = document.getElementById(id).getContext('2d');
        charts[id] = new Chart(ctx, {
            type: type,
            data: {
                labels: Object.keys(dataObj),
                datasets: [{
                    data: Object.values(dataObj),
                    backgroundColor: ['#E2001A', '#2D2D2D', '#FFB400', '#009688', '#5C6BC0']
                }]
            },
            options: {
                indexAxis: horizontal ? 'y' : 'x',
                responsive: true,
                maintainAspectRatio: false, // Obligatoire pour respecter la taille du parent fixe
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
</script>

</body>
</html>
